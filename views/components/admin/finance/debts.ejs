<div class="row">
    <div class="col-12">
        <div class="row">
            <div class="col-12">
                <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                    <h3 class="mb-sm-0">Qarzdorlik bo'limi</h3>
                    <div class="page-title-right">
                        <ol class="breadcrumb m-0">
                            <li class="breadcrumb-item text-danger">Bu bo'limda faqat to'lovni to'liq amalga oshirmagan
                                <br> o'quvchilar ro'yhati mavjud
                                mavjud
                            </li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
        <div class="row col md-12 col-sm-12 d-flex justify-content-start align-items-center">
            <button onclick="check_filter_school('school')" data-bs-toggle="offcanvas" data-bs-target="#FILTER_GENERAL"
                style="border-radius: 0;" aria-controls="FILTER_GENERAL" type="button"
                class="col-md-2 btn btn-outline-primary">
                <i class=" ri-filter-fill"></i> Filial bo'yicha
            </button>

            <button onclick="check_filter_school('group')" data-bs-toggle="offcanvas" data-bs-target="#FILTER_GROUP"
                style="border-radius: 0;" aria-controls="FILTER_GROUP" type="button"
                class="col-md-2 btn btn-outline-primary">
                <i class=" ri-filter-fill"></i> Guruhlar bo'yicha
            </button>

            <button onclick="check_filter_school('category_speciality')" data-bs-toggle="offcanvas"
                style="border-radius: 0;" data-bs-target="#FILTER_CATEGORY_SPECIALITY"
                aria-controls="FILTER_CATEGORY_SPECIALITY" type="button" class="col-md-3 btn btn-outline-primary">
                <i class=" ri-filter-fill"></i> Yo'nalish va kurs bo'yicha
            </button>
        </div>
        <div class="card mt-3">
            <div class="card-body">
                <table class="table table-striped table-bordered dt-responsive wrap text-center"
                    style="border-collapse: collapse; border-spacing: 0; width:  100%">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>O'quvchi</th>
                            <th>Guruh</th>
                            <th>Qaysi oy uchun</th>
                            <th>Status</th>
                            <th>To'langan</th>
                            <th>Qarzdorlik</th>
                            <th>To'langan sana</th>
                            <th>Sozlama</th>
                        </tr>
                    </thead>
                    <tbody class="put_tables">

                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<!-- Umumiy filtlash -->
<div class="offcanvas offcanvas-end" style="width: 50%" tabindex="-1" id="FILTER_GENERAL">
    <div class="offcanvas-header">
        <h5 class="font-size-22 mt-3 p-2 pl-5 pr-5 badge bg-dark">O'quv markaz bo'yicha filtrlash</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">

        <div class="row">
            <div class="col-md-12">
                <label class="form-label">O'quv markazni tanlang</label>
                <select class="form-control select2" id="SCHOOL_general"></select>
            </div>
        </div>
        <div class="col-md-12 col-sm-12">
            <label class="form-label mt-2">Oyni tanlang</label>
            <select class="select2 form-control select2-multiple col-md-12 col-sm-12" multiple="multiple"
                id="MONTH_general">
                <option value="1">Yanvar</option>
                <option value="2">Fevral</option>
                <option value="3">Mart</option>
                <option value="4">Aprel</option>
                <option value="5">May</option>
                <option value="6">Iyun</option>
                <option value="7">Iyul</option>
                <option value="8">Avgust</option>
                <option value="9">Sentyabr</option>
                <option value="10">Oktyabr</option>
                <option value="11">Noyabr</option>
                <option value="12">Dekabr</option>
            </select>
        </div>
        <div class="col-md-12 col-sm-12">
            <label class="form-label mt-2">Yilni tanlang</label>
            <select class="form-control select2 col-md-12 col-sm-12" id="YEAR_general">
                <option value="">Tanlang</option>
                <option value="2022">2022</option>
                <option value="2023">2023</option>
                <option value="2024">2024</option>
                <option value="2025">2025</option>
            </select>
        </div>
        <div class="row mt-3">
            <div class="col-md-12">
                <button type="button" onclick="GENERAL_FILTERING('school')"
                    class="col-md-12 btn btn-primary waves-effect waves-light">
                    Izlash
                </button>
            </div>
        </div>


    </div>
</div>

<!-- Guruh boyicha filtlash -->
<div class="offcanvas offcanvas-end" style="width: 50%" tabindex="-1" id="FILTER_GROUP">
    <div class="offcanvas-header">
        <h5 class="font-size-22 mt-3 p-2 pl-5 pr-5 badge bg-dark">Guruhlar bo'yicha filtrlash</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">

        <div class="row">
            <div class="col-md-12">
                <label class="form-label">O'quv markazni tanlang</label>
                <select class="form-control select2" onchange="FILTER_by_SCHOOL(this.value)"
                    id="SCHOOL_filtering"></select>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-12">
                <label class="form-label">Guruhni tanlang</label>
                <select class="select2 form-control select2-multiple col-md-12 col-sm-12" multiple="multiple"
                    id="GROUP_filtering"></select>
            </div>
        </div>

        <div class="col-md-12 col-sm-12">
            <label class="form-label mt-2">Oyni tanlang</label>
            <select class="select2 form-control select2-multiple col-md-12 col-sm-12" multiple="multiple"
                id="MONTH_filtering">
                <option value="1">Yanvar</option>
                <option value="2">Fevral</option>
                <option value="3">Mart</option>
                <option value="4">Aprel</option>
                <option value="5">May</option>
                <option value="6">Iyun</option>
                <option value="7">Iyul</option>
                <option value="8">Avgust</option>
                <option value="9">Sentyabr</option>
                <option value="10">Oktyabr</option>
                <option value="11">Noyabr</option>
                <option value="12">Dekabr</option>
            </select>
        </div>
        <div class="col-md-12 col-sm-12">
            <label class="form-label mt-2">Yilni tanlang</label>
            <select class="form-control select2 col-md-12 col-sm-12" id="YEAR_filtering">
                <option value="">Tanlang</option>
                <option value="2022">2022</option>
                <option value="2023">2023</option>
                <option value="2024">2024</option>
                <option value="2025">2025</option>
            </select>
        </div>
        <div class="row mt-3">
            <div class="col-md-12">
                <button type="button" onclick="GROUP_FILTERING('group')"
                    class="col-md-12 btn btn-primary waves-effect waves-light">
                    Izlash
                </button>
            </div>
        </div>


    </div>
</div>

<!-- Kategoriya va yo'nalish boyicha filtlash -->
<div class="offcanvas offcanvas-end" style="width: 50%" tabindex="-1" id="FILTER_CATEGORY_SPECIALITY">
    <div class="offcanvas-header">
        <h5 class="font-size-22 mt-3 p-2 pl-5 pr-5 badge bg-dark">Yo'nalish va kurslar bo'yicha filtrlash</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">

        <div class="row">
            <div class="col-md-12">
                <label class="form-label">O'quv markazni tanlang</label>
                <select class="form-control select2" onchange="FILTER_SCHOOLS(this.value)"
                    id="SCHOOL_filtered"></select>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <label class="form-label mt-2">Kategoriya nomi</label>
                <select class="form-control select2" onchange="FILTER_CATEGORIES(this.value)"
                    id="CATEGORY_filtered"></select>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <label class="form-label mt-2">Yo'nalish nomi</label>
                <select class="form-control select2" id="SPECIALITY_filtered"></select>
            </div>
        </div>
        <div class="col-md-12 col-sm-12">
            <label class="form-label mt-2">Oyni tanlang</label>
            <select class="select2 form-control select2-multiple col-md-12 col-sm-12" multiple="multiple"
                id="MONTH_filtered">
                <option value="1">Yanvar</option>
                <option value="2">Fevral</option>
                <option value="3">Mart</option>
                <option value="4">Aprel</option>
                <option value="5">May</option>
                <option value="6">Iyun</option>
                <option value="7">Iyul</option>
                <option value="8">Avgust</option>
                <option value="9">Sentyabr</option>
                <option value="10">Oktyabr</option>
                <option value="11">Noyabr</option>
                <option value="12">Dekabr</option>
            </select>
        </div>
        <div class="col-md-12 col-sm-12">
            <label class="form-label mt-2">Yilni tanlang</label>
            <select class="form-control select2 col-md-12 col-sm-12" id="YEAR_filtered">
                <option value="">Tanlang</option>
                <option value="2022">2022</option>
                <option value="2023">2023</option>
                <option value="2024">2024</option>
                <option value="2025">2025</option>
            </select>
        </div>
        <div class="row mt-3">
            <div class="col-md-12">
                <button type="button" onclick="CATEGORY_SPECIALITY_FILTERED('category_speciality')"
                    class="col-md-12 btn btn-primary waves-effect waves-light">
                    Izlash
                </button>
            </div>
        </div>


    </div>
</div>

<!-- Tahrirlash -->
<div class="offcanvas offcanvas-end" style="width: 50%" tabindex="-1" id="UPDATE_INCOME">
    <div class="offcanvas-header">
        <h5 class="font-size-22 mt-3 p-2 pl-5 pr-5 badge bg-dark">To'lovni amalga oshirish</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body updateIncome">

    </div>
</div>






<script src="/assets/axios.min.js"></script>
<script src="/assets/jquery.min.js"></script>
<script src="/assets/notification.js"></script>
<script src="/assets/libs/inputmask/jquery.inputmask.min.js"></script>
<script src="/assets/js/pages/form-mask.init.js"></script>

<script>

    let checkFilter;
    const check_filter_school = (check) => {
        return checkFilter = check
    }

    const restart = (check) => {
        if (check == "school") {
            GENERAL_FILTERING("school")
        }
        if (check == "group") {
            GROUP_FILTERING("group")
        }
        if (check == "category_speciality") {
            CATEGORY_SPECIALITY_FILTERED("category_speciality")
        }
    }




    const returnID = (item) => {
        return document.getElementById(item)
    }
    /* 
        @description: Managerning tokeni orqali unga tegishli o'quv markazlarni hammasini olish
        @api: /api/user/decode
        @method: GET
    */
    const setSelectionSingle = async (DATA, APPENDING, MESSAGE) => {
        if (DATA == "") {
            const appends = $(APPENDING);
            await appends.html("");
            appends.append(`<option value="" selected>Mavjud emas</option> `);
            danger(MESSAGE);
        } else {
            const appends = $(APPENDING);
            await appends.html("");
            appends.append(`<option value="" selected>Tanlash</option> `);
            DATA.forEach((item) => {
                appends.append(
                    `<option value="${item._id}">${item.name}</option>`
                );
            });
        }
    }
    const setSelectionMultiple = async (DATA, APPENDING, MESSAGE) => {
        if (DATA == "") {
            const appends = $(APPENDING);
            await appends.html("");
            danger(MESSAGE);
        } else {
            const appends = $(APPENDING);
            await appends.html("");
            DATA.forEach((item) => {
                appends.append(
                    `<option value="${item._id}">${item.name}</option>`
                );
            });
        }
    }



    const UserToken = window.localStorage.getItem('user')
    axios.get('/api/user/decode', { headers: { authorization: UserToken } }).then((res) => {
        const id = res.data.id;
        axios.get(`/api/user/${id}`).then(async (res) => {
            const school = res.data.data.school
            setSelectionSingle(school, "#SCHOOL", "Iltimos yangi o'quv markazi yarating")
            setSelectionSingle(school, "#general_filter_SCHOOL", "Iltimos yangi o'quv markazi yarating")
            setSelectionSingle(school, "#SCHOOL_general", "Iltimos yangi o'quv markazi yarating")
            setSelectionSingle(school, "#SCHOOL_filtering", "Iltimos yangi o'quv markazi yarating")
            setSelectionSingle(school, "#SCHOOL_filtered", "Iltimos yangi o'quv markazi yarating")
        })
    })
    /* 
        @description: O'quv markazga tegishli kategoriyalarni va guruhlarni olish
        @api: /api/school/:id
        @method: GET
    */
    const FILTER_SCHOOL = (id) => {
        axios.get(`/api/group/filter/${id}`, { params: { actions: "active" } }).then(async (res) => {
            const data = res.data.data
            setSelectionSingle(data, "#GROUP", "O'quv markazga tegishli guruhlar mavjud emas. Iltimos guruh biriktiring")

        });
        axios.get(`/api/school/${id}`).then(async (res) => {
            const data = res.data.data.category
            setSelectionSingle(data, "#CATEGORY", "O'quv markazi uchun kategoriyalar biriktirilmagan. Iltimos kategoriya biriktiring")
        });
    }
    const FILTER_SCHOOLS = (id) => {
        axios.get(`/api/school/${id}`).then(async (res) => {
            const data = res.data.data.category
            setSelectionSingle(data, "#CATEGORY_filtered", "O'quv markazi uchun kategoriyalar biriktirilmagan. Iltimos kategoriya biriktiring")
        });
    }
    const FILTER_by_SCHOOL = (id) => {
        axios.get(`/api/group/filter/${id}`, { params: { actions: "active" } }).then(async (res) => {
            const data = res.data.data
            setSelectionMultiple(data, "#GROUP_filtering", "O'quv markazga tegishli guruhlar mavjud emas. Iltimos guruh biriktiring")
        });
    }



    /* 
        @description: Kategoriya boyicha yonlaishlarni filtrlash
        @api: /api/speciality/filter/:id
        @method: GET
    */
    const FILTER_CATEGORY = (id) => {
        axios.get(`/api/speciality/filter/${id}`, { params: { actions: "active" } }).then(async (res) => {
            const data = res.data.data
            setSelectionSingle(data, "#SPECIALITY", "Ushbu kategoriya bo'yicha yo'nalish mavjud emas")
        });
    }
    const FILTER_CATEGORIES = (id) => {
        axios.get(`/api/speciality/filter/${id}`, { params: { actions: "active" } }).then(async (res) => {
            const data = res.data.data
            setSelectionSingle(data, "#SPECIALITY_filtered", "Ushbu kategoriya bo'yicha yo'nalish mavjud emas")
        });
    }



    /* 
        @description: Guruh boyicha o'quvchilarni olish
        @api: /api/group/filter_by_group
        @method: GET
    */
    const FILTER_GROUP = (id) => {
        axios.get(`/api/user/filter_by_group`, { params: { group: id, role: "student", actions: "active" } }).then(async (res) => {
            const data = res.data.data
            setSelectionSingle(data, "#STUDENT", "Guruh bo'yicha o'quvchilar mavjud emas. Iltimos ushbu guruh uchun o'quvchi qo'shing !")
        });
    }



    /*
        @description: Umumiy filtrlash
        @api: /api/income/filter
        @method: GET
    */
    const setHTML = async (data) => {
        const element = $('.put_tables');
        console.log(data);
        await element.html("")
        data.forEach((item, index) => {
            element.append(`
                <tr>
                    <td>${index + 1}</td>
                    <td>${item.user.name}</td>
                    <td>${item.group.name}</td>
                    <td class="getMonths"></td>
                    <td class="getStatus"></td>
                    <td><span class="badge bg-success font-size-14 p-2">${item.amount}</span></td>
                    <td class="debtors"></td>
                    <td>${new Date(item.createdAt).toLocaleDateString()}</td>
                    <td>
                        <div class="btn-group">
                            <button style="padding: 5px 9px; font-size: 16px;" type="button" class="btn btn-dark dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-cog"></i>
                            </button>
                            <div class="dropdown-menu">
                                <a onclick="updateIncome('${item._id}')" data-bs-toggle="offcanvas" data-bs-target="#UPDATE_INCOME" aria-controls="UPDATE_INCOME" class="dropdown-item" href="#">
                                    <i class="fas fa-retweet"></i> Qayta to'lov qilish    
                                </a>
                            </div>
                        </div>
                    </td>
                </tr>
            `)

            const month = document.getElementsByClassName("getMonths");
            month.forEach((inputs, inputsIndex) => {
                if (inputsIndex == index) {
                    if (item.month == "1") {
                        inputs.innerHTML = `<span class="badge bg-secondary text-light font-size-14 p-2">Yanvar - ${item.year}</span>`
                    }
                    if (item.month == "2") {
                        inputs.innerHTML = `<span class="badge bg-secondary text-light font-size-14 p-2">Fevral - ${item.year}</span>`
                    }
                    if (item.month == "3") {
                        inputs.innerHTML = `<span class="badge bg-secondary text-light font-size-14 p-2">Mart - ${item.year}</span>`
                    }
                    if (item.month == "4") {
                        inputs.innerHTML = `<span class="badge bg-secondary text-light font-size-14 p-2">Aprel - ${item.year}</span>`
                    }
                    if (item.month == "5") {
                        inputs.innerHTML = `<span class="badge bg-secondary text-light font-size-14 p-2">May - ${item.year}</span>`
                    }
                    if (item.month == "6") {
                        inputs.innerHTML = `<span class="badge bg-secondary text-light font-size-14 p-2">Iyun - ${item.year}</span>`
                    }
                    if (item.month == "7") {
                        inputs.innerHTML = `<span class="badge bg-secondary text-light font-size-14 p-2">Iyul - ${item.year}</span>`
                    }
                    if (item.month == "8") {
                        inputs.innerHTML = `<span class="badge bg-secondary text-light font-size-14 p-2">Avgust - ${item.year}</span>`
                    }
                    if (item.month == "9") {
                        inputs.innerHTML = `<span class="badge bg-secondary text-light font-size-14 p-2">Sentyabr - ${item.year}</span>`
                    }
                    if (item.month == "10") {
                        inputs.innerHTML = `<span class="badge bg-secondary text-light font-size-14 p-2">Oktyabr - ${item.year}</span>`
                    }
                    if (item.month == "11") {
                        inputs.innerHTML = `<span class="badge bg-secondary text-light font-size-14 p-2">Noyabr - ${item.year}</span>`
                    }
                    if (item.month == "12") {
                        inputs.innerHTML = `<span class="badge bg-secondary text-light font-size-14 p-2">Dekabr - ${item.year}</span>`
                    }

                }
            })

            const debtors = document.getElementsByClassName("debtors");
            debtors.forEach((inputs, inputsIndex) => {
                if (inputsIndex == index) {
                    if (typeof item.reminderSumm == "undefined" || !item.reminderSumm || item.reminderSumm == "0") {
                        inputs.innerHTML = " - "
                    } else {
                        inputs.innerHTML = `<span class=" badge bg-danger font-size-14 p-2">${item.reminderSumm}</span>`
                    }
                }
            })

            const status = document.getElementsByClassName("getStatus");
            status.forEach((inputs, inputsIndex) => {
                if (inputsIndex == index) {
                    if (item.status == "debtor") {
                        inputs.innerHTML = `<span class="badge bg-danger font-size-14 p-2">Qarzdor</span>`
                    }
                    if (item.status == "no_debtor") {
                        inputs.innerHTML = `<span class="badge bg-success font-size-14 p-2">Qarzdor emas</span>`
                    }
                }
            })
        })
    }
    const GENERAL_FILTERING = async (check) => {
        if (check == "school") {
            const school = returnID("SCHOOL_general").value
            const month = returnID("MONTH_general")
            const year = returnID("YEAR_general").value
            const months = []
            for (const item of month) {
                if (item.selected) {
                    months.push(item.value)
                }
            }
            if (school == "" || months == "" || year == "") {
                danger("Ma'lumotlarni to'liq kiriting")
            }
            else {
                axios.get('/api/income/debts', {
                    params: {
                        check: check,
                        school: school,
                        month: months,
                        year: year
                    }
                }).then(async (res) => {
                    const data = res.data.data;

                    if (data == "") {
                        warning("Ma'lumot topilmadi")
                    }
                    else {
                        setHTML(data)
                        success("Muvaffaqiyatli ma'lumot olindi")
                    }


                })
            }
        }
    }
    const GROUP_FILTERING = async (check) => {
        if (check == "group") {

            const containArray = (element) => {
                const arrayDemo = []
                for (const item of element) {
                    if (item.selected) {
                        arrayDemo.push(item.value)
                    }
                }
                return arrayDemo
            }

            const school = returnID("SCHOOL_filtering").value
            const group = returnID("GROUP_filtering")
            const month = returnID("MONTH_filtering")
            const year = returnID("YEAR_filtering").value

            if (school == "" || containArray(group) == "" || containArray(month) == "" || year == "") {
                danger("Ma'lumotlarni to'liq kiriting")
            }
            else {
                axios.get('/api/income/debts', {
                    params: {
                        check: check,
                        school: school,
                        group: containArray(group),
                        month: containArray(month),
                        year: year
                    }
                }).then(async (res) => {
                    const data = res.data.data;
                    setHTML(data)
                    success("Muvaffaqiyatli ma'lumot olindi")
                })
            }
        }
    }


    /*
        @description: Umumiy filtrlash
        @api: /api/income/filter
        @method: PUT
    */
    const updateIncome = (id) => {
        axios.get(`/api/income/${id}`).then(async (res) => {
            const data = res.data.data;
            const element = $(".updateIncome");
            await element.html("");
            element.append(`
                <div class="row">
                    <div class="col-md-12">
                        <label class="form-label" for="input-repeat">To'lovni qayta kiriting</label>
                        <input type="number" id="inputElement" class="form-control" onkeyup="checkData('${data.reminderSumm}', ${data.amount})" />
                        <span id="remindElem" class="badge bg-warning font-size-12 p-1 mt-1"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <button type="button" onclick="updateSum('${data._id}')" class=" mt-3 btn btn-success waves-effect waves-light mt-2">
                            Tahrirlash
                        </button> 
                    </div>
                </div>
            `);
            if (typeof data.reminderSumm == undefined || !data.reminderSumm || data.reminderSumm == "0") {
                returnID('remindElem').innerHTML = `To'lanishi kerak bo'lgan summa: 0 so'm`
            } else {
                returnID('remindElem').innerHTML = `To'lanishi kerak bo'lgan summa: ${data.reminderSumm} so'm`

            }
        })
    }
    const checkData = (a, b) => {
        const typing = parseInt(returnID('inputElement').value);
        const reminder = parseInt(a)
        const paid = parseInt(b)

        if (typing > reminder) {
            danger(`Iltimos kiri tayotgan summangiz ${reminder} so'mdan oshmasligi kerak`)
            returnID('inputElement').value = ""
        }
    }
    const updateSum = (id) => {
        const inputs = returnID('inputElement').value;
        if (inputs == "") {
            danger("Malumotni to'liq kiriting")
        } else {
            axios.put(`/api/income/${id}`, {
                summa: inputs
            }).then((res) => {
                const data = res.data.success;
                if (data === false) {
                    warning("Ushbu to'lov uchun qarzdorlik mavjud emas.")
                } else {
                    restart(checkFilter)
                    success("Malumot qayta tahrirlandi, Tabriklaymiz")
                }
            })
        }

    }

</script>